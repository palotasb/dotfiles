#!/usr/bin/env sh

# Usage:
#   eval "$(curl -fsSL https://raw.githubusercontent.com/palotasb/dotfiles/master/.local/bin/setup-dotfiles)"
#   DOTFILES_REPO=https://example.com/dotfiles.git eval "$(curl -fsSL https://raw.githubusercontent.com/palotasb/dotfiles/master/.local/bin/setup-dotfiles)"
# or:
#   curl -fsSL https://raw.githubusercontent.com/palotasb/dotfiles/master/.local/bin/setup-dotfiles > setup-dotfiles
#   . setup-dotfiles

# Get .dotfiles
DOTFILES_DIR="$HOME/.dotfiles$DOTFILES"
DOTFILES_BRANCH="${DOTFILES_BRANCH:-${DOTFILES:-master}}"
DOTFILES_REPO="${DOTFILES_REPO:-https://github.com/palotasb/dotfiles}"
git clone "$DOTFILES_REPO" --branch "$DOTFILES_BRANCH" "$DOTFILES_DIR"

# Use global `config` alias to manage .dotfiles in $HOME
# Sync with same alias in .config/shell/alias.sh
alias config="git --git-dir=\"\$HOME/.dotfiles\$DOTFILES/.git\" --work-tree=\"\$HOME\""
alias config-repo="git --git-dir=\"\$HOME/.dotfiles\$DOTFILES/.git\" --work-tree=\"\$HOME/.dotfiles\$DOTFILES/\""

# Back up old .dotfiles that we will overwrite
# Sync with config-backup from .config/shell/functions.sh
timestamp=$(date +%Y-%m-%d-%H-%M-%S)
dir="$HOME/.dotfiles${DOTFILES}/.bak-${timestamp}"
files=$(config-repo ls-files | xargs -d ' ' -I % echo %)
files=$(echo "${files}" | xargs -I  __F sh -c "if [ -f \"$HOME/__F\" ]; then echo \"__F\"; fi")
echo "${files}" | xargs -I __F echo "${dir}/__F" | xargs -I __F mkdir -p __F
echo "${files}" | xargs -I __F cp -a "$HOME/__F" "${dir}/__F"
if [ "$1" != --quiet ] ; then
    echo "${files}"
fi
unset files ; unset dir ; unset timestamp

# Ignore all other files in $HOME
config config status.showUntrackedFiles no

# Overwrite config with stored data
config reset --hard

# Source into current bash or zsh shell
if ( echo "$0" | grep -qE "(^\-?|/)bash$" ) ; then
  . "$HOME/.bashrc"
elif ( echo "$0" | grep -qE "(^\-?|/)bash$" ) ; then
  . "$HOME/.zshrc"
fi

# Install https://starship.rs/ for custom prompt
install-starship --verbose --yes --bin-dir "$HOME/.local/bin"

# Source into shell again (activate prompt)
config-source
